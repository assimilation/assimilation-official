language: minimal

env:
  global:
    - VERSION=0.1.0

stages:
  - name: lint
    if: branch = remove_to_enable

  - name: tests
    if: branch = remove_to_enable

  - name: "create packages"

  - name: "test packages"
    if: branch = remove_to_enable

jobs:
  include:

    - stage: lint
      name: lint
      script:
        - echo "run some linter"

    - stage: tests
      name: tests
      after_success:
        - echo "do some tests"

    - stage: "create packages"
      name: "create packages"
      after_success:
        - docker build --build-arg VERSION -f ci/Dockerfiles/ubuntu1804_fpm.dockerfile -t ubuntu_fpm /tmp
        - docker build --build-arg VERSION -f ci/Dockerfiles/centos7_fpm.dockerfile -t centos_fpm /tmp
        - docker run -v /tmp/output:/output ubuntu_fpm bash -c "cp /workdir/*.deb /output"
        - docker run -v /tmp/output:/output centos_fpm bash -c "cp /workdir/*.rpm /output"
        - ls -al /tmp/output/*.deb /tmp/output/*.rpm
        - echo "upload packages to bintray"
        - curl -T /tmp/output/nanoprobe-${VERSION}-1.x86_64.rpm -u$BINTRAY_USER:$BINTRAY_PASS https://api.bintray.com/content/assimilation/rpm/nanoprobe/$VERSION/
        - curl -T /tmp/output/nanoprobe_${VERSION}_amd64.deb -u$BINTRAY_USER:$BINTRAY_PASS https://api.bintray.com/content/assimilation/deb/nanoprobe/$VERSION/;deb_distribution=bionic;deb_component=universe;deb_architecture=amd64

    - stage: "test packages"
      name: "test packages"
      script:
        - echo "download packages"
        - echo "test them out"

script:
  - echo "build binaries"
    # create dummy nanoprobe binary
  - echo "echo \"nanoprobe binary\"" > /tmp/nanoprobe
  - chmod a+x /tmp/nanoprobe
